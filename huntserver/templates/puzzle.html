{% extends "base.html" %}
{% block title %}Puzzle - {{ puzzle.puzzle_name }}{% endblock title %}

{% block includes %}
<script src="{{ STATIC_URL }}jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/ws4redis.js"></script>
{% endblock includes %}

{% block right-header %}
  <a href='/'>Go back to all puzzles</a>
{% endblock %}

{% block content %}
<div class='puzzle'>
  <div class='info'>
    <h1><a href='{{ puzzle.link }}'>
      P{{ puzzle.puzzle_number}} - {{ puzzle.puzzle_name }}
    </a></h1>
  </div>

  <fieldset id='submit'>
    <legend>Submit an answer</legend>
    <form id='sub_form' action="/puzzle/{{ puzzle.puzzle_id }}/" method='post'>
      {% csrf_token %}
      <div>
        {{ form }}
        <input type='submit' value='Submit' data-disable-with='Submitting...'/>
      </div>
    </form>
  </fieldset>
  <fieldset id='answers'>
    <legend>Past answers (automatically updated)</legend>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Answer</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id='sub_table'>
        {% for submission in submission_list reversed%}
        <tr data-id='{{submission.pk}}'>
         <td>{{ submission.submission_time|time:"h:i a" }}</td>
         <td>{{ submission.submission_text }} </td>
         <td>{{ submission.response_text }}</td>
       </tr>
       {% endfor %}
     </tbody>
   </table>
 </fieldset>
</div>
<script>
jQuery(document).ready(function($) {
  var ws4redis = WS4Redis({
    uri: '{{ WEBSOCKET_URI }}puzzle_submissions?subscribe-user',
    receive_message: receiveMessage,
    heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
  });

  $('#sub_form').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url : $(this).attr('action') || window.location.pathname,
      type: "POST",
      data: $(this).serialize(),
      error: function (jXHR, textStatus, errorThrown) {
        alert(errorThrown);
      }
    });
  }); 

  // receive a message though the websocket from the server
  function receiveMessage(msg) {
    submission = JSON.parse(msg);
    if(submission.puzzle == "{{ puzzle.puzzle_id }}"){
      d = new Date();
      d.setTime(Date.parse(submission['submission_time']));
      hours = d.getHours() > 12 ? d.getHours()-12 : d.getHours(); 
      minutes = d.getMinutes().toString().length == 1 ? ("0" + d.getMinutes()) : d.getMinutes()
      time = hours.toString().length  == 1 ? "0" + hours : hours
      time = time + ":" + minutes;
      time = time + (d.getHours() > 12 ? " p.m." : " a.m.");
      row = $("<tr data-id='" + submission['pk'] + "'> </tr>");
      col1 = $("<td> " + time + " </td>");
      col2 = $("<td> " + submission['submission_text'] + " </td>");
      col3 = $("<td> " + submission['response_text'] + " </td>");
      row.append(col1,col2,col3);
      if ($('tr[data-id=' + submission['pk'] + ']').length == 0) {
        row.prependTo("#sub_table");
      } else {
        $('tr[data-id=' + submission['pk'] + ']').replaceWith(row);
      }
    }
  }
});
</script>
{% endblock content %}
